<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aru's Fun World</title>
    <!-- PWA: Link to the manifest file -->
    <link rel="manifest" href="manifest.json">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap');
        
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #e0f2fe, #fce7f3);
            margin: 0;
            padding: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            color: #1e293b;
        }

        .app-container {
            width: 100%;
            max-width: 800px;
            background-color: #fff;
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.1);
            border-radius: 2rem;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            min-height: 80vh;
            margin: 1rem;
        }

        header {
            background-color: #f0f9ff;
            padding: 1.5rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 2px solid #e2e8f0;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        header .logo {
            font-size: 2.5rem;
            font-weight: 900;
            color: #6d28d9;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .header-button {
            padding: 0.75rem 1rem;
            background-color: #8b5cf6;
            color: white;
            border: none;
            border-radius: 9999px;
            font-size: 1rem;
            font-weight: 700;
            cursor: pointer;
            transition: background-color 0.2s, transform 0.2s;
        }

        .header-button:hover {
            background-color: #7c3aed;
            transform: scale(1.05);
        }

        .main-content {
            flex-grow: 1;
            padding: 2rem;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
        }

        .page-title {
            font-size: 3rem;
            font-weight: 900;
            color: #4c1d95;
            margin-bottom: 1rem;
        }
        
        .page-description {
            font-size: 1.25rem;
            color: #475569;
            max-width: 600px;
            margin-bottom: 2rem;
        }

        .game-menu {
            display: grid;
            grid-template-columns: 1fr;
            gap: 2rem;
            width: 100%;
            max-width: 600px;
        }

        @media (min-width: 640px) {
            .game-menu {
                grid-template-columns: repeat(3, 1fr);
            }
        }

        .game-card {
            background-color: #f0f9ff;
            padding: 2rem;
            border-radius: 1.5rem;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.05);
            cursor: pointer;
            transition: transform 0.3s, box-shadow 0.3s;
        }

        .game-card:hover {
            transform: translateY(-8px);
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.1);
        }

        .game-card-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
        }
        
        .game-card-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: #4c1d95;
        }

        .game-card-text {
            color: #64748b;
        }

        /* Puzzle Page Styles */
        .puzzle-container {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 4px;
            width: 400px;
            height: 400px;
            border: 4px solid #a78bfa;
            border-radius: 1rem;
            background-color: #f3e8ff;
            margin-bottom: 1.5rem;
        }

        .puzzle-piece {
            width: 100%;
            height: 100%;
            cursor: pointer;
            background-image: url('https://placehold.co/400x400/a78bfa/ffffff?text=Aru');
            background-size: 300% 300%;
            border: 2px solid #f3e8ff;
            transition: border-color 0.2s, transform 0.2s;
        }

        .puzzle-piece.selected {
            border-color: #facc15;
            transform: scale(1.05);
            z-index: 1;
        }

        .puzzle-actions {
            display: flex;
            flex-direction: column;
            gap: 1rem;
            width: 100%;
            max-width: 400px;
        }
        
        .puzzle-actions input {
            padding: 0.75rem;
            border-radius: 9999px;
            border: 2px solid #a78bfa;
            font-size: 1rem;
            text-align: center;
        }
        
        .puzzle-actions .btn {
            width: 100%;
        }

        /* Memory Game Styles */
        .memory-game-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 1rem;
            padding: 1rem;
            background-color: #e2e8f0;
            border-radius: 1.5rem;
        }

        .memory-card {
            width: 70px;
            height: 70px;
            font-size: 2.5rem;
            border-radius: 0.75rem;
            background-color: #a78bfa;
            color: white;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            transition: transform 0.3s, background-color 0.3s;
            transform-style: preserve-3d;
            position: relative;
        }

        .memory-card .card-face {
            position: absolute;
            width: 100%;
            height: 100%;
            backface-visibility: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
            border-radius: 0.75rem;
            transition: transform 0.3s;
        }

        .memory-card .front-face {
            background-color: #a78bfa;
        }

        .memory-card .back-face {
            background-color: #8b5cf6;
            color: white;
            transform: rotateY(180deg);
        }

        .memory-card.flipped .front-face {
            transform: rotateY(180deg);
        }

        .memory-card.flipped .back-face {
            transform: rotateY(0deg);
        }
        
        .memory-card.matched {
            background-color: #34d399;
            cursor: default;
        }
        
        .memory-card:not(.matched):not(.flipped):hover {
            transform: scale(1.05);
        }

        /* Whack-a-Mole Game Styles */
        .whack-a-mole-container {
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        .whack-a-mole-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            grid-template-rows: repeat(3, 1fr);
            gap: 1rem;
            width: 350px;
            height: 350px;
            padding: 1rem;
            background-color: #a78bfa;
            border-radius: 1.5rem;
            margin-top: 1rem;
        }

        .hole {
            position: relative;
            background-color: #fce7f3;
            border-radius: 50%;
            overflow: hidden;
            border: 4px solid #8b5cf6;
        }

        .mole {
            position: absolute;
            bottom: 0;
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: flex-end;
            font-size: 3rem;
            transform: translateY(100%);
            transition: transform 0.3s ease-out;
            cursor: pointer;
        }
        
        .mole.up {
            transform: translateY(0);
        }

        .game-info {
            display: flex;
            justify-content: space-around;
            width: 100%;
            max-width: 350px;
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 1rem;
        }

        /* Utility classes */
        .hidden { display: none; }
        .text-center { text-align: center; }
        .mt-4 { margin-top: 1rem; }
        .btn {
            padding: 0.75rem 1.5rem;
            background-color: #8b5cf6;
            color: white;
            border: none;
            border-radius: 9999px;
            font-size: 1rem;
            font-weight: 700;
            cursor: pointer;
            transition: background-color 0.2s, transform 0.2s;
        }
        .btn:hover {
            background-color: #7c3aed;
            transform: scale(1.05);
        }
        .win-message {
            font-size: 2rem;
            font-weight: 900;
            color: #16a34a;
            animation: pulse 1.5s infinite;
        }
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <header>
            <div class="logo">
                <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-hand-heart"><path d="M11 14h2a2 2 0 0 0 2-2v-2a2 2 0 0 0-2-2H9a2 2 0 0 0-2 2v2a2 2 0 0 0 2 2h2"></path><path d="M11 14a3 3 0 0 0-3-3v-2l1-4a4 4 0 0 1 4-4h.5a4 4 0 0 1 4 4l1 4v2a3 3 0 0 0-3 3"></path><path d="M16 14h2a2 2 0 0 1 2 2v2a2 2 0 0 1-2 2h-2a2 2 0 0 1-2-2v-2a2 2 0 0 1 2-2z"></path><path d="M18 14h-2a2 2 0 0 0-2 2v2a2 2 0 0 0 2 2h2a2 2 0 0 0 2-2v-2a2 2 0 0 0-2-2z"></path><path d="M22 17a3 3 0 0 0-3-3h-2.5a3 3 0 0 0-3 3v2a3 3 0 0 0 3 3h2.5a3 3 0 0 0 3-3v-2z"></path><path d="M22 17h-2.5a3 3 0 0 0-3 3v2a3 3 0 0 0 3 3h2.5a3 3 0 0 0 3-3v-2a3 3 0 0 0-3-3z"></path><path d="M17 19h-2a2 2 0 0 0-2 2v2a2 2 0 0 0 2 2h2a2 2 0 0 0 2-2v-2a2 2 0 0 0-2-2z"></path><path d="M17 19a2 2 0 0 0-2-2h-2a2 2 0 0 0-2 2v2a2 2 0 0 0 2 2h2a2 2 0 0 0 2-2v-2z"></path><path d="M12 2a4 4 0 0 1 4 4l1 4v2a3 3 0 0 1-3 3h-2a3 3 0 0 1-3-3v-2l1-4a4 4 0 0 1 4-4z"></path></svg>
                Aru's Fun World
            </div>
            <button class="header-button" onclick="navigateTo('home')">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-home"><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>
            </button>
        </header>

        <main class="main-content" id="app-main-content">
            <!-- Content will be injected here by JavaScript -->
        </main>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.min.js"></script>
    <script>
        // PWA: Register the service worker
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('service-worker.js')
                    .then(registration => {
                        console.log('Service Worker registered with scope:', registration.scope);
                    })
                    .catch(error => {
                        console.error('Service Worker registration failed:', error);
                    });
            });
        }
        
        // Global state to manage the current page
        let currentPage = 'home';
        let currentPuzzleImage = 'https://placehold.co/400x400/a78bfa/ffffff?text=Aru';

        // Sound Effects
        const synth = new Tone.Synth().toDestination();
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
        let audioSource = null;

        const playClickSound = () => {
            synth.triggerAttackRelease('C4', '8n');
        };

        const playMatchSound = () => {
            // Updated to play a single note instead of a chord to fix the Tone.js error
            synth.triggerAttackRelease('G5', '8n');
        };

        const playFailSound = () => {
            synth.triggerAttackRelease('C3', '8n');
        };

        const playWinSound = () => {
            synth.triggerAttackRelease(['C4', 'E4', 'G4'], '4n');
        };

        const playPopSound = () => {
            synth.triggerAttackRelease('D5', '16n');
        };

        const playGameOverSound = () => {
            // Updated to play notes sequentially to avoid the Tone.js error with chords
            const notes = ['C3', 'B2', 'A2'];
            let time = Tone.now();
            notes.forEach(note => {
                synth.triggerAttackRelease(note, '8n', time);
                time += 0.2; // Add a small delay for each note
            });
        };
        
        // Function to convert PCM audio data to a WAV blob
        function pcmToWav(pcmData, sampleRate) {
            const numChannels = 1;
            const bytesPerSample = 2; // 16-bit PCM
            const blockAlign = numChannels * bytesPerSample;
            const byteRate = sampleRate * blockAlign;

            const buffer = new ArrayBuffer(44 + pcmData.length * bytesPerSample);
            const view = new DataView(buffer);
            let offset = 0;

            function writeString(str) {
                for (let i = 0; i < str.length; i++) {
                    view.setUint8(offset + i, str.charCodeAt(i));
                }
                offset += str.length;
            }

            function writeUint32(val) {
                view.setUint32(offset, val, true);
                offset += 4;
            }

            function writeUint16(val) {
                view.setUint16(offset, val, true);
                offset += 2;
            }

            // RIFF chunk
            writeString('RIFF');
            writeUint32(36 + pcmData.length * bytesPerSample);
            writeString('WAVE');

            // fmt sub-chunk
            writeString('fmt ');
            writeUint32(16); // sub-chunk size
            writeUint16(1);  // audio format (1 = PCM)
            writeUint16(numChannels);
            writeUint32(sampleRate);
            writeUint32(byteRate);
            writeUint16(blockAlign);
            writeUint16(bytesPerSample * 8); // bits per sample

            // data sub-chunk
            writeString('data');
            writeUint32(pcmData.length * bytesPerSample);

            for (let i = 0; i < pcmData.length; i++) {
                view.setInt16(offset, pcmData[i], true);
                offset += bytesPerSample;
            }

            return new Blob([view], { type: 'audio/wav' });
        }
        
        // Function to decode base64 to ArrayBuffer
        function base64ToArrayBuffer(base64) {
            const binaryString = atob(base64);
            const len = binaryString.length;
            const bytes = new Uint8Array(len);
            for (let i = 0; i < len; i++) {
                bytes[i] = binaryString.charCodeAt(i);
            }
            return bytes.buffer;
        }

        // --- Page Rendering Functions ---
        const appContainer = document.getElementById('app-main-content');

        function renderHomePage() {
            appContainer.innerHTML = `
                <h2 class="page-title">Welcome, Aru!</h2>
                <p class="page-description">
                    Get ready to explore a world of exciting puzzles and fun games. Choose your adventure below!
                </p>
                <div class="game-menu">
                    <button class="game-card" onclick="navigateTo('puzzle')">
                        <div class="game-card-icon">🧩</div>
                        <div class="game-card-title">Play a Puzzle</div>
                        <p class="game-card-text">Generate a new picture and solve the puzzle!</p>
                    </button>
                    <button class="game-card" onclick="navigateTo('memory')">
                        <div class="game-card-icon">🧠</div>
                        <div class="game-card-title">Memory Match</div>
                        <p class="game-card-text">Find matching pairs in this fun game!</p>
                    </button>
                    <button class="game-card" onclick="navigateTo('whack-a-mole')">
                        <div class="game-card-icon">👻</div>
                        <div class="game-card-title">Whack-a-Mole</div>
                        <p class="game-card-text">Tap the friendly ghosts as they pop up!</p>
                    </button>
                </div>
                <button class="btn mt-4" id="say-hi-btn">
                  <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-megaphone"><path d="m3 11 18-5v12L3 14v-3z"/><path d="M11.6 16.8a3 3 0 1 1-5.8-1.6"/><path d="M12.51 16.96a3 3 0 1 1-5.91-1.74"/></svg>
                  &nbsp; Say Hello! ✨
                </button>
            `;
            document.getElementById('say-hi-btn').addEventListener('click', handleSayHiClick);
        }

        function renderPuzzlePage() {
            appContainer.innerHTML = `
                <h2 class="page-title">Aru's Puzzle Challenge</h2>
                <p class="page-description">Create a new puzzle image below, or click on two pieces to swap them!</p>
                <div class="puzzle-container" id="puzzle-container"></div>
                <div id="puzzle-win-message" class="hidden win-message mt-4">You did it, Aru! Great job!</div>
                <div class="puzzle-actions mt-4">
                  <input type="text" id="image-prompt" placeholder="Describe a picture for your puzzle..." value="a happy cartoon dinosaur playing with a ball">
                  <button id="generate-puzzle-btn" class="btn">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-sparkles"><path d="M9.9 22c-.6.3-1.4.3-2 0L4 19l-3-5 3-5 3.9-3c.6-.3 1.4-.3 2 0L14 5l3 5-3 5-3.9 3z"/><path d="M22 17c-.6.3-1.4.3-2 0l-3.9-3c-.6-.3-1.4-.3-2 0l-3.9 3c-.6.3-1.4.3-2 0L5 19l-3-5 3-5 3.9-3c.6-.3 1.4-.3 2 0L14 5l3 5-3 5-3.9 3z"/></svg>
                    &nbsp; Generate Puzzle ✨
                  </button>
                  <button id="puzzle-reset-button" class="btn hidden">Play Again</button>
                  <div id="loading-indicator" class="hidden text-center mt-4">Generating image...</div>
                </div>
            `;
            document.getElementById('generate-puzzle-btn').addEventListener('click', generateAndSetPuzzleImage);
            document.getElementById('puzzle-reset-button').addEventListener('click', () => initPuzzleGame(currentPuzzleImage));
            initPuzzleGame(currentPuzzleImage);
        }

        function renderMemoryGamePage() {
            appContainer.innerHTML = `
                <h2 class="page-title">Memory Match</h2>
                <p class="page-description">Click on two cards to find a match!</p>
                <div class="memory-game-grid" id="memory-game-grid"></div>
                <div id="memory-win-message" class="hidden win-message mt-4">You've matched them all, Aru! You're a star!</div>
                <button id="memory-reset-button" class="btn mt-4 hidden">Play Again</button>
            `;
            initMemoryGame();
        }
        
        function renderWhackAMolePage() {
            appContainer.innerHTML = `
                <h2 class="page-title">Whack-a-Mole</h2>
                <p class="page-description">Tap the friendly ghosts as they pop up to score points!</p>
                <div class="game-info">
                    <span id="score">Score: 0</span>
                    <span id="time-left">Time: 30s</span>
                </div>
                <div class="whack-a-mole-grid" id="whack-a-mole-grid"></div>
                <button id="whack-a-mole-start-btn" class="btn mt-4">Start Game!</button>
                <div id="game-over-message" class="hidden win-message mt-4">Game Over!</div>
            `;
            document.getElementById('whack-a-mole-start-btn').addEventListener('click', initWhackAMoleGame);
        }

        // --- Navigation Logic ---
        function navigateTo(page) {
            playClickSound();

            // Check if a Whack-a-Mole game is running and stop it before navigating away
            if (currentPage === 'whack-a-mole' && isWhackAMoleRunning) {
                clearInterval(gameTimer);
                clearTimeout(moleTimer);
                isWhackAMoleRunning = false;
            }

            currentPage = page;
            switch (currentPage) {
                case 'home':
                    renderHomePage();
                    break;
                case 'puzzle':
                    renderPuzzlePage();
                    break;
                case 'memory':
                    renderMemoryGamePage();
                    break;
                case 'whack-a-mole':
                    renderWhackAMolePage();
                    break;
            }
        }

        // --- Puzzle Game Logic ---
        let puzzlePieces = [];
        let selectedPieceIndex = null;
        let isPuzzleSolved = false;
        
        function initPuzzleGame(imageUrl) {
            const puzzleContainer = document.getElementById('puzzle-container');
            const puzzleResetButton = document.getElementById('puzzle-reset-button');
            const winMessage = document.getElementById('puzzle-win-message');
            
            // Set the new image for the game
            currentPuzzleImage = imageUrl;

            // Generate and shuffle the pieces
            puzzlePieces = Array.from({ length: 9 }, (_, i) => i);
            shuffleArray(puzzlePieces);
            
            puzzleContainer.innerHTML = '';
            
            puzzlePieces.forEach((pieceId, index) => {
                const piece = document.createElement('div');
                piece.className = 'puzzle-piece';
                piece.style.backgroundImage = `url(${currentPuzzleImage})`;
                piece.style.backgroundPosition = `
                    ${(-pieceId % 3) * (100 / 2)}% 
                    ${Math.floor(pieceId / 3) * (100 / 2)}%
                `;
                piece.onclick = () => handlePuzzleClick(index);
                puzzleContainer.appendChild(piece);
            });
            
            winMessage.classList.add('hidden');
            puzzleResetButton.classList.add('hidden');
            isPuzzleSolved = false;
        }
        
        function handlePuzzleClick(index) {
            if (isPuzzleSolved) return;

            const pieces = document.querySelectorAll('.puzzle-piece');
            const clickedPiece = pieces[index];

            if (selectedPieceIndex === null) {
                // First piece selected
                selectedPieceIndex = index;
                clickedPiece.classList.add('selected');
                playClickSound();
            } else {
                // Second piece selected, swap them
                playClickSound();
                const newPieces = [...puzzlePieces];
                [newPieces[selectedPieceIndex], newPieces[index]] = [newPieces[index], newPieces[selectedPieceIndex]];
                puzzlePieces = newPieces;

                // Update the background positions on the DOM
                pieces.forEach((piece, i) => {
                    const newPieceId = puzzlePieces[i];
                    piece.style.backgroundImage = `url(${currentPuzzleImage})`;
                    piece.style.backgroundPosition = `
                        ${(-newPieceId % 3) * (100 / 2)}% 
                        ${Math.floor(newPieceId / 3) * (100 / 2)}%
                    `;
                    piece.classList.remove('selected');
                });

                selectedPieceIndex = null;
                checkPuzzleWin();
            }
        }

        function checkPuzzleWin() {
            const isSolved = puzzlePieces.every((piece, index) => piece === index);
            if (isSolved) {
                playWinSound();
                isPuzzleSolved = true;
                document.getElementById('puzzle-win-message').classList.remove('hidden');
                document.getElementById('puzzle-reset-button').classList.remove('hidden');
            }
        }

        // Gemini API integration for generating a new puzzle image
        async function generateAndSetPuzzleImage() {
            const prompt = document.getElementById('image-prompt').value;
            const loadingIndicator = document.getElementById('loading-indicator');
            const generateButton = document.getElementById('generate-puzzle-btn');

            loadingIndicator.classList.remove('hidden');
            generateButton.disabled = true;

            let retryCount = 0;
            const maxRetries = 3;
            let delay = 1000;

            while (retryCount < maxRetries) {
                try {
                    const payload = { 
                        instances: [{ prompt: prompt }], 
                        parameters: { "sampleCount": 1 } 
                    };
                    const apiKey = "";
                    const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/imagen-3.0-generate-002:predict?key=${apiKey}`;

                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    
                    if (response.ok) {
                        const result = await response.json();
                        const base64Data = result?.predictions?.[0]?.bytesBase64Encoded;

                        if (base64Data) {
                            const imageUrl = `data:image/png;base64,${base64Data}`;
                            initPuzzleGame(imageUrl);
                            loadingIndicator.classList.add('hidden');
                            generateButton.disabled = false;
                            return;
                        }
                    }
                    
                    throw new Error(`API call failed with status: ${response.status}`);
                } catch (error) {
                    console.error('Image generation error:', error);
                    retryCount++;
                    if (retryCount < maxRetries) {
                        await new Promise(res => setTimeout(res, delay));
                        delay *= 2;
                    }
                }
            }

            loadingIndicator.textContent = "Failed to generate image. Please try again.";
            generateButton.disabled = false;
        }

        // Gemini API integration for text-to-speech
        async function handleSayHiClick() {
            const btn = document.getElementById('say-hi-btn');
            btn.disabled = true;
            btn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-volume-2"><path d="M15 8a5 5 0 0 1 0 8"/><path d="M17.7 5a9 9 0 0 1 0 14"/><path d="M8 6L4 9H2v6h2l4 3V6z"/></svg>&nbsp; Talking...`;
            
            let retryCount = 0;
            const maxRetries = 3;
            let delay = 1000;

            while (retryCount < maxRetries) {
                try {
                    const payload = {
                        contents: [{
                            parts: [{ text: "Hello Aru! Have fun playing today. You're a super star!" }]
                        }],
                        generationConfig: {
                            responseModalities: ["AUDIO"],
                            speechConfig: {
                                voiceConfig: { prebuiltVoiceConfig: { voiceName: "Kore" } }
                            }
                        }
                    };
                    const apiKey = "";
                    const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-tts:generateContent?key=${apiKey}`;

                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    
                    if (response.ok) {
                        const result = await response.json();
                        const audioData = result?.candidates?.[0]?.content?.parts?.[0]?.inlineData?.data;
                        const mimeType = result?.candidates?.[0]?.content?.parts?.[0]?.inlineData?.mimeType;
                        
                        if (audioData && mimeType && mimeType.startsWith("audio/")) {
                            const sampleRate = parseInt(mimeType.match(/rate=(\d+)/)[1], 10);
                            const pcmData = base64ToArrayBuffer(audioData);
                            const pcm16 = new Int16Array(pcmData);
                            const wavBlob = pcmToWav(pcm16, sampleRate);
                            
                            if (audioSource) audioSource.stop();
                            
                            const audioUrl = URL.createObjectURL(wavBlob);
                            const audio = new Audio(audioUrl);
                            audio.play();

                            audio.onended = () => {
                                btn.disabled = false;
                                btn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-megaphone"><path d="m3 11 18-5v12L3 14v-3z"/><path d="M11.6 16.8a3 3 0 1 1-5.8-1.6"/><path d="M12.51 16.96a3 3 0 1 1-5.91-1.74"/></svg>&nbsp; Say Hello! ✨`;
                            };
                            return;
                        }
                    }

                    throw new Error(`API call failed with status: ${response.status}`);
                } catch (error) {
                    console.error('TTS error:', error);
                    retryCount++;
                    if (retryCount < maxRetries) {
                        await new Promise(res => setTimeout(res, delay));
                        delay *= 2;
                    } else {
                        btn.disabled = false;
                        btn.innerHTML = `Error Talking...`;
                    }
                }
            }
        }

        // --- Memory Game Logic ---
        const emojiPairs = ['🐶', '🐱', '🐭', '🐰', '🦊', '🐻', '🐼', '🐯', '🐶', '🐱', '🐭', '🐰', '🦊', '🐻', '🐼', '🐯'];
        let cards = [];
        let flippedCards = [];
        let matchedCards = [];
        let canFlip = true;
        
        function initMemoryGame() {
            const gameGrid = document.getElementById('memory-game-grid');
            const resetButton = document.getElementById('memory-reset-button');
            const winMessage = document.getElementById('memory-win-message');
            
            cards = emojiPairs.map((emoji, index) => ({ id: index, emoji, isFlipped: false, isMatched: false }));
            shuffleArray(cards);
            
            gameGrid.innerHTML = '';
            cards.forEach(card => {
                const cardElement = document.createElement('div');
                cardElement.classList.add('memory-card');
                cardElement.dataset.id = card.id;
                cardElement.innerHTML = `
                    <div class="card-face front-face">?</div>
                    <div class="card-face back-face">${card.emoji}</div>
                `;
                cardElement.onclick = () => handleMemoryCardClick(card.id);
                gameGrid.appendChild(cardElement);
            });
            
            flippedCards = [];
            matchedCards = [];
            canFlip = true;
            winMessage.classList.add('hidden');
            resetButton.classList.add('hidden');

            resetButton.onclick = initMemoryGame;
        }

        function handleMemoryCardClick(cardId) {
            if (!canFlip || flippedCards.length >= 2) return;
            
            const cardIndex = cards.findIndex(c => c.id === cardId);
            const card = cards[cardIndex];
            
            if (card.isFlipped || card.isMatched) return;

            // Flip the card and add to flipped list
            card.isFlipped = true;
            flippedCards.push(cardId);
            
            const cardElement = document.querySelector(`[data-id='${cardId}']`);
            cardElement.classList.add('flipped');
            playClickSound();

            if (flippedCards.length === 2) {
                canFlip = false;
                const [firstId, secondId] = flippedCards;
                const firstCard = cards.find(c => c.id === firstId);
                const secondCard = cards.find(c => c.id === secondId);

                if (firstCard.emoji === secondCard.emoji) {
                    // It's a match!
                    firstCard.isMatched = true;
                    secondCard.isMatched = true;
                    matchedCards.push(firstId, secondId);
                    
                    document.querySelector(`[data-id='${firstId}']`).classList.add('matched');
                    document.querySelector(`[data-id='${secondId}']`).classList.add('matched');

                    flippedCards = [];
                    canFlip = true;
                    playMatchSound();
                    
                    if (matchedCards.length === cards.length) {
                        playWinSound();
                        document.getElementById('memory-win-message').classList.remove('hidden');
                        document.getElementById('memory-reset-button').classList.remove('hidden');
                    }

                } else {
                    // No match, flip them back
                    setTimeout(() => {
                        firstCard.isFlipped = false;
                        secondCard.isFlipped = false;
                        
                        document.querySelector(`[data-id='${firstId}']`).classList.remove('flipped');
                        document.querySelector(`[data-id='${secondId}']`).classList.remove('flipped');
                        
                        flippedCards = [];
                        canFlip = true;
                        playFailSound();
                    }, 1000);
                }
            }
        }
        
        // --- Whack-a-Mole Logic ---
        let score = 0;
        let timeLeft = 30;
        let lastHole = null;
        let gameTimer = null;
        let moleTimer = null;
        let isWhackAMoleRunning = false;

        function initWhackAMoleGame() {
            score = 0;
            timeLeft = 30;
            isWhackAMoleRunning = true;
            
            document.getElementById('score').textContent = `Score: ${score}`;
            document.getElementById('time-left').textContent = `Time: ${timeLeft}s`;
            document.getElementById('whack-a-mole-start-btn').textContent = 'Stop Game';
            document.getElementById('whack-a-mole-start-btn').removeEventListener('click', initWhackAMoleGame);
            document.getElementById('whack-a-mole-start-btn').addEventListener('click', stopWhackAMoleGame);
            document.getElementById('game-over-message').classList.add('hidden');

            const grid = document.getElementById('whack-a-mole-grid');
            grid.innerHTML = '';
            for (let i = 0; i < 9; i++) {
                const hole = document.createElement('div');
                hole.classList.add('hole');
                const mole = document.createElement('div');
                mole.classList.add('mole');
                mole.textContent = '👻';
                mole.addEventListener('click', handleMoleWhack);
                hole.appendChild(mole);
                grid.appendChild(hole);
            }
            
            startGameLoop();
        }

        function stopWhackAMoleGame() {
            isWhackAMoleRunning = false;
            clearInterval(gameTimer);
            clearTimeout(moleTimer);
            document.getElementById('whack-a-mole-start-btn').textContent = 'Play Again';
            document.getElementById('whack-a-mole-start-btn').removeEventListener('click', stopWhackAMoleGame);
            document.getElementById('whack-a-mole-start-btn').addEventListener('click', initWhackAMoleGame);
            document.getElementById('game-over-message').classList.remove('hidden');
            playGameOverSound();
        }

        function startGameLoop() {
            showMole();
            gameTimer = setInterval(() => {
                timeLeft--;
                document.getElementById('time-left').textContent = `Time: ${timeLeft}s`;
                if (timeLeft <= 0) {
                    stopWhackAMoleGame();
                }
            }, 1000);
        }

        function showMole() {
            if (!isWhackAMoleRunning) return;
            const holes = document.querySelectorAll('.mole');
            const randomHole = getRandomHole(holes);
            randomHole.classList.add('up');
            
            const time = Math.random() * 1000 + 500; // Moles are up for 0.5s to 1.5s
            moleTimer = setTimeout(() => {
                randomHole.classList.remove('up');
                if (isWhackAMoleRunning) {
                    showMole();
                }
            }, time);
        }

        function getRandomHole(holes) {
            const index = Math.floor(Math.random() * holes.length);
            const hole = holes[index];
            if (hole === lastHole) {
                return getRandomHole(holes);
            }
            lastHole = hole;
            return hole;
        }

        function handleMoleWhack(event) {
            if (!isWhackAMoleRunning || !event.target.classList.contains('up')) return;
            
            score++;
            document.getElementById('score').textContent = `Score: ${score}`;
            playPopSound();
            
            event.target.classList.remove('up');
        }

        // --- Utility Functions ---
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
        }

        // Initial render on page load
        window.onload = () => {
            renderHomePage();
        };
    </script>
</body>
</html>
